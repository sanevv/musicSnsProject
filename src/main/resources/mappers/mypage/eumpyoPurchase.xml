<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="eumpyoPurchase">

	<!-- 구매 내역 1건 추가 -->
	<insert id="insertPurchaseHistory" parameterType="map">
    	insert into purchase_history (user_id, purchased_at, at_that_user_coin)
    	values (#{userId}, systimestamp, #{atThatUserCoin})
    	returning purchase_history_id
    	into #{purchaseHistoryId, javaType=long, jdbcType=NUMERIC, mode=OUT}
  	</insert>

 	<!-- 곡 행 추가 -->
  	<insert id="insertPurchaseMusic" parameterType="map">
    	insert into purchase_music (music_id, purchase_history_id, at_that_coin)
    	values (#{musicId}, #{purchaseHistoryId}, #{usedCoin})
  	</insert>

  	<!-- 현재 사용자 코인 조회 (단순 조회) -->
  	<select id="selectUserCoin" parameterType="long" resultType="long">
    	select nvl(coin, 0)
    	from users
    	where user_id = #{value}
  	</select>

  	<!-- 사용자 음표 재정산 -->
  	<update id="recalcUserCoinFromHistory" parameterType="map">
	    update users u
	       set u.coin =
	         ( nvl((select sum(c.coin)
	                 from coin_history c
	                where c.user_id = #{userId}), 0)
	           -
	           nvl((select sum(pm.at_that_coin)
	                 from purchase_history p
	                 join purchase_music pm
	                   on pm.purchase_history_id = p.purchase_history_id
	                where p.user_id = #{userId}), 0)
	         )
	     where u.user_id = #{userId}
  	</update>

  	<!-- 현재 사용자 코인 조회 (잠금/동시수정불가) -->
  	<select id="selectUserCoinForUpdate" parameterType="long" resultType="long">
    	select nvl(coin, 0)
      	from users
     	where user_id = #{value}
     	for update
  	</select>

</mapper>
