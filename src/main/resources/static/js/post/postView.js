// token.jsÏóêÏÑú Ìï®ÏàòÎì§ Í∞ÄÏ†∏Ïò§Í∏∞
const apiRequest = AuthFunc.apiRequest;//Ìï®ÏàòÏ∞∏Ï°∞

$(document).ready(function(){

    return apiRequest(()=>
        new Promise((resolve, reject)=>{

            $.ajax({
                url: "/api/post/postView",
                type: "get",
                headers: AuthFunc.getAuthHeader(),
                success: function (data) {

                    let v_html = ``;

                    data.forEach(item => {

                        // console.log(item.username);
                        // console.log(item.profileImage);

                        // followPostVOList Í∞Ä ÎπÑÏñ¥ÏûàÎäî Í≤ΩÏö∞, Î∑∞Îã®ÏóêÎäî "Îì±Î°ùÎêú Í≤åÏãúÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§." Î•º ÎÇòÌÉÄÎÇòÍ≤å Ìï®
                        if(item == null){
                            v_html += `<span style="font-weight: bold; text-align: center">Îì±Î°ùÎêú Í≤åÏãúÎ¨ºÏù¥ ÏóÜÏäµÎãàÎã§.</span>`;
                        }
                        else{
                            v_html += `
                            <div class="post" data-post-id="${item.postId}">
                                <div class="post-header">
                                    <div class="post-header-left">
                                        <img class="profileImage" src="${item.profileImage}" alt="ÌîÑÎ°úÌïÑ">
                                        <span class="username">${item.username}</span>
                                    </div>
                                    <div class="post-header-right">
                                        <span style="color: #5e35b1; font-weight: bold">${item.emotionLabel}</span>
                                        <button type="button" class="menu-btn">‚ãÆ</button>
                                    </div>
                                </div>`;

                            const postImageUrls = item.post_image_urls;

                            // Ïù¥ÎØ∏ÏßÄÍ∞Ä 2Ïû• Ïù¥ÏÉÅÏùº ÎïåÎßå indicator ÌëúÏãú (JSPÏôÄ ÎèôÏùºÌïòÍ≤å)
                            if (postImageUrls && postImageUrls.length > 1) {
                                const carouselId = `carousel-${item.postId}`; // Ïà´Ïûê id ÎåÄÎπÑÏö© Ï†ëÎëêÏñ¥

                                // indicators
                                const indicatorsHtml = postImageUrls
                                    .map((_, idx) =>
                                        `<li data-target="#${carouselId}" data-slide-to="${idx}" ${idx === 0 ? 'class="active"' : ''}></li>`
                                    )
                                    .join('');

                                // slides
                                const slidesHtml = postImageUrls
                                    .map((url, idx) =>
                                        `<div class="carousel-item ${idx === 0 ? 'active' : ''}">
                                             <img src="${url}" class="d-block w-100" alt="">
                                         </div>`
                                    )
                                    .join('');

                                // Ï†ÑÏ≤¥ ÎßàÌÅ¨ÏóÖ
                                v_html += `<div id="${carouselId}" class="carousel slide" data-interval="false">
                                              <ol class="carousel-indicators">
                                                ${indicatorsHtml}
                                              </ol>
                                              <div class="carousel-inner">
                                                ${slidesHtml}
                                              </div>
                                              <a class="carousel-control-prev" href="#${carouselId}" role="button" data-slide="prev">
                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                <span class="sr-only">Previous</span>
                                              </a>
                                              <a class="carousel-control-next" href="#${carouselId}" role="button" data-slide="next">
                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                <span class="sr-only">Next</span>
                                              </a>
                                           </div>`;
                            } // end of if(postImageUrls && postImageUrls.length > 1) {}

                            v_html += `<div class="post-actions">`;

                            if(item.myLiked){
                                v_html += `<button type="button" class="btn like" style="background-image: url('/images/like/purpleLove.png') " onclick="goLike(${item.postId}, this)"><span class="blind">ÌïòÌä∏</span></button>`;
                            }
                            else {
                                v_html += `<button type="button" class="btn like" onclick="goLike(${item.postId}, this)"><span class="blind">ÌïòÌä∏</span></button>`;
                            }

                            v_html += `    <button type="button" name="comments" id="comments" data-post-id="${item.postId}" data-toggle="modal" data-target="#twoColumnModal">üí¨</button>
                                           <button type="button" name="" id="">üì§</button>
                                       </div>
                                       <div class="post-content">
                                            <div class="title">${item.title}</div>
                                            <div class="likes">Ï¢ãÏïÑÏöî ${item.postLikeCnt ?? 0}Í∞ú</div>
                                            <div class="caption"><span style="font-size: 11pt; font-weight: bold">${item.username}</span> <b class="contents">${item.contents}</b></div>
                                       </div>
                                   </div>`;
                        }

                    }) // end of data.forEach(item => {})

                    $('div#feed').html(v_html);

                },
                error: function(xhr, textStatus, errorThrown) {
                    // axios Ïä§ÌÉÄÏùºÏùò ÏóêÎü¨ Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                    const error = new Error(errorThrown || textStatus);
                    error.response = {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        data: xhr.responseJSON || xhr.responseText
                    };
                    error.request = xhr;
                    reject(error);
                }


            }) // end of $.ajax({})


        })
    );



    /*function ÎåìÍ∏ÄÎì±Î°ù(){
        const body = {
            'title' : "Ï†úÎ™©",
            'contents' : 'ÎÇ¥Ïö©'
        }
        AuthFunc.apiRequest(()=>{
             axios.post('/api/post/comment',
                body
                ,{
                    headers: AuthFunc.getAuthHeader()
                })
        }).then(function (response) {


            const data = response.data;
        }).catch(function (error) {

        })
    }*/

}) // end of $(document).ready(function(){})

$(function () {

    // ÎåìÍ∏Ä Î™®ÏñëÏùÑ ÎàÑÎ•¥Î©¥ Î™®Îã¨ÏùÑ ÎÇòÏò§Í≤å Ìï®
    $('div.feed-container').on('click', 'button[name="comments"]', function () {
        const post = $(this).closest('.post');
        // console.log(post);

        const postId = post.data('post-id');
        const postTitle = post.find('.title').text().trim();
        const postContent = post.find('.contents').text().trim();
        const username = post.find('.username').text().trim();
        // ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉùÏûêÍ∞Ä Îã§Î•∏ Ïù¥ÎØ∏ÏßÄÏôÄ ÏÑûÏù¥ÏßÄ ÏïäÎèÑÎ°ù Íµ¨Ï≤¥Ìôî Í∂åÏû•
        const profileImage = post.find('.profileImage').attr('src') || '';
        // Î™®Îì† Ïù¥ÎØ∏ÏßÄ URL
        let postImageUrls = post.find('.carousel-inner img').map((_, img) => $(img).attr('src')).get();


        // console.log(postId);
        // console.log(postTitle);
        // console.log(postContent);
        // console.log(username);
        // console.log(profileImage);
        // console.log(imageUrls);

        let carouselSeq = 0;
        function nextCarouselId(postId) {
            return `carousel-${postId}-${++carouselSeq}-${Math.random().toString(36).slice(2,6)}`;
        }

        const carouselId = nextCarouselId(postId);
        const html = buildCarouselHtml(postImageUrls, carouselId);

        $('.post-image-area').html(html);
        $('.pcUserImage').attr('src', profileImage);
        $('.pcUserName').text(username);
        $('.pcPostTitle').text(postTitle);
        $('.pcPostContent').text(postContent);

        AuthFunc.apiRequest(()=>{
            axios.get('/api/comment/getCommentList',
                {params: {postId: postId}},
                {headers: AuthFunc.getAuthHeader()})
                .then(async function (response) {

                    let html = ``;

                    const commentList = response.data;

                    // console.log(commentList);

                    commentList.forEach(item => {

                        html += `
                                     <div class="comment d-flex mb-2"
                                     data-comment-id="${item.commentId}"
                                     data-writer="${item.writer}">
                                        <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ -->
                                        <img src= "${item.writerProfileImageUrl}" class="rounded-circle mr-2" 
                                             alt="userImage" style="width:32px; height:32px; object-fit:cover;">
                                
                                        <!-- ÎãâÎÑ§ÏûÑ + ÎåìÍ∏Ä ÎÇ¥Ïö© -->
                                        <div class="d-flex flex-column">
                                            <div>
                                                <span class="font-weight-bold mr-1">${item.writer}</span>
                                                <span>${item.contents}</span>
                                            </div>
                                
                                            <!-- ÎãµÍ∏Ä -->
                                            <div class="text-muted small mt-1">
                                                <span>${item.createdAt}</span>
                                                <span class="ml-3 reply-btn" role="button" tabindex="0" style="font-style: italic">ÎãµÍ∏Ä Îã¨Í∏∞( Í∞ú)</span>
                                            </div>
                                        </div>
                                        <!-- ‚úÖ ÎãµÍ∏Ä nÍ∞ú Î≥¥Í∏∞ Î≤ÑÌäº -->
                                        <div class="text-muted small mt-1 view-replies-btn" role="button" tabindex="0" style="cursor:pointer">
                                          -- ÎãµÍ∏Ä Î≥¥Í∏∞
                                        </div>
                                    
                                        <!-- ‚úÖ ÎåÄÎåìÍ∏ÄÏù¥ Îì§Ïñ¥Í∞à ÏòÅÏó≠ -->
                                        <div class="replies pl-4 mt-2" style="display:none;"></div>
                                    </div>
                        `;

                    })

                    await $('.pcCommentsArea').html(html);

                }).catch(function (error) {

            })

        })

        // ÎåìÍ∏ÄÏì∞Í∏∞ÏóêÏÑú Í∞íÏù¥ ÏóÜÏúºÎ©¥ disabled, Í∞íÏù¥ ÏûàÏúºÎ©¥ Ìï¥Ï†ú
        $('textarea.pcCommentInput').on('input', function() {
            $('button.commentPost').prop('disabled', $(this).val().trim() === "");
        });

        $('textarea.pcCommentInput').on('keyup', function(e) {
            if(e.keyCode === 13) {
                $('button.commentPost').trigger('click');
            }
        })

        // ÎãµÍ∏ÄÎ≥¥Í∏∞ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ ÎÇòÌÉÄÎÇòÎäî Í≤É
        $('div.view-replies-btn').on('click', function () {
            $('div.replies').style.display = 'block';
        })

        // ÎãµÍ∏ÄÎã¨Í∏∞ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ ÎåìÍ∏ÄÏì∞Í∏∞Ïóê Í∞í ÎÑ£Ïñ¥Ï£ºÍ≥†, Î∂ÄÎ™®ÎåìÍ∏ÄÏïÑÏù¥Îîî ÎßåÎì§Í∏∞
        let parentCommentId = null;

        $('span.reply-btn').on('click', function () {

            const writer = $(this).closest('.comment').data('writer');
            parentCommentId = $(this).closest('.comment').data('comment-id');

            $('textarea.pcCommentInput').val(`@${writer} `).focus();
        })

        // "Í≤åÏãú" Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ ÎåìÍ∏ÄÏùÑ dbÏóê Ï†ÄÏû•ÌïòÎäî Í≤É
        $('button.commentPost').on('click', function () {

            const body = {
                'postId': postId,
                'comment': $('textarea.pcCommentInput').val().trim(),
                'parentCommentId': parentCommentId,
            }
            AuthFunc.apiRequest(() => {
                axios.post('/api/comment/insertComment',
                    body,
                    {headers: AuthFunc.getAuthHeader()})
            }).then(function (response) {

                if(response.parentCommentId != null) {
                    let html1 = ``;

                    html1 += `
                            <div class="comment d-flex mb-2"
                                     data-comment-id="${response.commentId}"
                                     data-writer="${response.writer}">
                                        <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ -->
                                        <img src= "${response.writerProfileImageUrl}" class="rounded-circle mr-2" 
                                             alt="userImage" style="width:32px; height:32px; object-fit:cover;">
                                
                                        <!-- ÎãâÎÑ§ÏûÑ + ÎåìÍ∏Ä ÎÇ¥Ïö© -->
                                        <div class="d-flex flex-column">
                                            <div>
                                                <span class="font-weight-bold mr-1">${response.writer}</span>
                                                <span>${response.contents}</span>
                                            </div>
                                        </div>
                            </div>
                    `;

                    // $('div.replies').last().append(html1);
                    $('div.replies').html(html1);
                    return;
                }

                $('textarea.pcCommentInput').val('');

            }).catch(function (error) {
                console.error(error);

                const status = error?.response?.status;
                const data = error?.response?.data;

                if (status === 409) {
                    const msg =
                        (typeof data === 'string' && data) ||
                        data?.customMessage ||
                        'ÏöîÏ≤≠Ïù¥ Ï∂©ÎèåÎêòÏñ¥ Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.';
                    alert(msg);
                } else {
                    alert('ÎåìÍ∏Ä ÏûÖÎ†•Ïù¥ ÏïàÎê®.');
                }

            })

        })


    }) // end of $('div.feed-container').on('click', 'button[name="comments"]', function () {})

}) // end of $(function () {})




// ÎåìÍ∏Ä Ïù¥Î™®Ìã∞ÏΩòÏùÑ ÎàÑÎ•¥Î©¥ ÎÇòÏò§Îäî Î™®Îã¨Ïóê Ï∫êÎü¨ÏÖÄÎßåÎìúÎäî Ìï®Ïàò
function buildCarouselHtml(imageUrls, carouselId) {
    if (!imageUrls || imageUrls.length === 0) {
        return '<div class="text-muted d-flex align-items-center justify-content-center" style="height: 200px;">Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
    }

    if (imageUrls.length === 1) {
        return `<img src="${imageUrls[0]}" class="img-fluid rounded" alt="post image">`;
    }

    const indicatorsHtml = imageUrls
        .map((_, idx) =>
            `<li data-target="#${carouselId}" data-slide-to="${idx}" ${idx === 0 ? 'class="active"' : ''}></li>`
        )
        .join('');

    const slidesHtml = imageUrls
        .map((url, idx) =>
            `<div class="carousel-item ${idx === 0 ? 'active' : ''}">
         <img src="${url}" class="d-block w-100" alt="post image ${idx + 1}">
       </div>`
        )
        .join('');

    const controlsHtml = `
    <a class="carousel-control-prev" href="#${carouselId}" role="button" data-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#${carouselId}" role="button" data-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>`;

    return `
    <div id="${carouselId}" class="carousel slide" data-ride="carousel">
      <ol class="carousel-indicators">${indicatorsHtml}</ol>
      <div class="carousel-inner">${slidesHtml}</div>
      ${controlsHtml}
    </div>
  `;
}


// Ï¢ãÏïÑÏöîÎ•º ÎàÑÎ•¥Î©¥ ÌïòÌä∏ÏÉâ Î≥ÄÍ≤Ω Î∞è Ï¢ãÏïÑÏöîÏàò Ïπ¥Ïö¥Ìä∏ Ìï®Ïàò
function goLike(postId, thisBtn) {

    // ÏÇ¨Ïö©ÏûêÏùò Ïó∞ÌÉÄ Î∞è DB Ï§ëÎ≥µ, ÏÑ±Îä•Ï†ÄÌïòÎ•º Î∞©ÏßÄÌïòÍ∏∞ ÏúÑÌï¥ busy ÌîåÎûòÍ∑∏ ÏÇ¨Ïö©.
    const $btn = $(thisBtn);
    if ($btn.data('busy')) return;
    $btn.data('busy', true);

    return apiRequest(()=>
        $.ajax({
            url:"/api/like/goLike",
            data: {postId: postId},
            dataType: "json",
            type: "POST",
            headers: AuthFunc.getAuthHeader(),
            success: function (json) {

                const $card = $btn.closest('.post');           // Ìï¥Îãπ Ïπ¥Îìú Ìïú Ïû•
                const $likes = $card.find('.likes');

                if(json.isExist) {
                    // like ÌÖåÏù¥Î∏îÏóê save Í∞Ä ÏÑ±Í≥µÎêòÏñ¥ÏßÄÎ©¥ ÏÜçÏù¥Îπà ÌïòÌä∏Î•º ÏÜçÏù¥ Ï∞¨ ÌïòÌä∏Î°ú Î∞îÍæºÎã§.
                    $(thisBtn).css('background-image', "url('/images/like/purpleLove.png')");
                }
                else{
                    // like ÌÖåÏù¥Î∏îÏóê Ïù¥ÎØ∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎã§Î©¥ ÏÜçÏù¥ Îπà ÌïòÌä∏Î°ú Î∞îÍøîÏ§ÄÎã§.
                    $(thisBtn).css('background-image', "url('/images/like/emptyLove.png')");
                }

                // Ï¢ãÏïÑÏöî Ïàò Í∞±Ïã† (ÏÑúÎ≤ÑÏóêÏÑú ÎÇ¥Î†§Ï§Ä Í∞íÏù¥ ÏûàÏùÑ Îïå)
                if (typeof json.postLikeCnt === 'number') {
                    $likes.text(`Ï¢ãÏïÑÏöî ${json.postLikeCnt}Í∞ú`);
                } else {
                    // ÏÑúÎ≤ÑÍ∞Ä likeCountÎ•º Ïïà ÎÇ¥Î†§Ï§Ñ Í≤ΩÏö∞Ïùò ÏïàÏ†ÑÌïú Ìè¥Î∞±(ÎÇôÍ¥ÄÏ†Å ÏóÖÎç∞Ïù¥Ìä∏)
                    const prev = parseInt(($likes.text().match(/\d+/) || [0])[0], 10);
                    const next = json.isExist ? prev + 1 : Math.max(prev - 1, 0);
                    $likes.text(`Ï¢ãÏïÑÏöî ${next}Í∞ú`);
                }


            },
            error: function (xhr, status, error) {
                alert(xhr.responseText);
            },
            complete: function () {
                $btn.data('busy', false);
            }
        })
    );

} // end of function goLike(postId, thisBtn) {}


